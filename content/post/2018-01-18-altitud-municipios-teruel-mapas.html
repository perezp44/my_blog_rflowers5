---
title: Altitud municipios Teruel (mapas)
author: Pedro J. P√©rez
date: '2018-01-18'
slug: altitud-municipios-teruel-mapas
categories: [municipios]
tags: [spatial maps]
description: 'Voy a refrescar mis conocimientos sobre mapas en R. Para ello voy a hacer varios gr√°ficos espaciales con las altitudes de los municipios de Teruel. Usar√© el paquete `sf`.'
#banner:   'banners/nest_pas_unconf.png'
#images:     #['img/nest_pas_unconf.png']
#menu: ''
---



<div id="intro" class="section level3">
<h3>Intro</h3>
<p>En el post anterior hice <a href="https://es.wikipedia.org/wiki/Web_scraping">web scrapping</a> baj√°ndome una tabla con los municipios de Teruel con su altitud; pero no hice ning√∫n mapa. Hoy voy a hacerlos.</p>
<p>Primero hace falta bajarse <a href="https://es.wikipedia.org/wiki/Anexo:Municipios_de_la_provincia_de_Teruel">esta tabla</a> de la Wikipedia con las altitudes y guardarla en un dataframe. Esto lo expliqu√© en el <a href="http://rflowers4.netlify.com/blog/2017/12/23/altitud-de-los-pueblos-de-teruel-web-scrapping/">post anterior</a> as√≠ que ya tenemos la tabla con las altitudes almacenada en un dataframe que se llama <code>Teruel</code>. Tuvimos que limpiarla un poquito!! Abajo est√° todo el c√≥digo que use en un √∫nico chunk:</p>
<pre class="r"><code>#devtools::install_github(&quot;perezp44/personal.pjp&quot;)
library(&quot;personal.pjp&quot;)

library(&quot;rvest&quot;)
library(&quot;tidyverse&quot;)
content &lt;- read_html(&quot;https://es.wikipedia.org/wiki/Anexo:Municipios_de_la_provincia_de_Teruel&quot;)
head &lt;- content %&gt;% html_nodes(&#39;head&#39;) 
head &lt;- content %&gt;% html_nodes(&#39;head&#39;) %&gt;% html_text()

body_table &lt;- content %&gt;% html_nodes(&#39;body&#39;)  %&gt;%
                    html_nodes(&#39;table&#39;) %&gt;%
                    html_table(dec = &quot;,&quot;) 
Teruel &lt;- body_table[[1]]
names(Teruel) &lt;- c(&quot;Nombre&quot;, &quot;Extension&quot;, &quot;Poblacion&quot;, &quot;Densidad&quot;, &quot;Comarca&quot;, &quot;Partido_judicial&quot;, &quot;Altitud&quot;)
library(stringr)
Teruel &lt;- Teruel %&gt;% map(str_trim) %&gt;% as.tibble() #- quita caracteres al final
Teruel &lt;- Teruel %&gt;% mutate(Altitud = str_replace_all(Altitud,&quot;[[:punct:]]&quot;, &quot;&quot;))
Teruel &lt;- Teruel %&gt;% mutate(Poblacion = str_replace_all(Poblacion,&quot; &quot;, &quot;&quot;))
Teruel &lt;- Teruel %&gt;% mutate(Poblacion = as.double(Poblacion))
Teruel &lt;- Teruel %&gt;% mutate(Altitud = as.double(Altitud)) %&gt;%    
                     arrange(desc(Altitud))</code></pre>
<p>Os recordar√© que Valdelinares es el pueblo ‚Äúm√°s alto‚Äù de Teruel, seguido de Griegos, pero ¬øy mi pueblo? Mi pueblo se llama <a href="https://es.wikipedia.org/wiki/Pancrudo">Pancrudo</a> y es muuuuuuyy alto, pero ve√°moslo en un gr√°fico.</p>
<p><br></p>
</div>
<div id="mapa-con-las-altitudes" class="section level3">
<h3>Mapa con las altitudes</h3>
<p><br></p>
<p>Primero he cargar los datos de lindes municipales. No quiero liarme mucho as√≠ que cargar√© el fichero que usaba hace uno/dos a√±itos. No lo voy a actualizar ni chequear. <strong>PERO</strong>, lo que s√≠ que he hecho es crear un package en Github para poder cargar los datos que uso en el blog desde R. Lo puedes ver <a href="https://github.com/perezp44/mypkgDataforblog">aqu√≠</a>. Creo que en uno de los siguientes post contar√© c√≥mo y porque lo he hecho. No me quiero liar ahora. Me hac√≠a falta!!</p>
<pre class="r"><code>#devtools::install_github(&quot;perezp44/mypkgDataforblog&quot;)
library(mypkgDataforblog)
library(rgdal)
municipios &lt;- municipios_CNIG  #- los cargo de mi pkg
rm(aa, body_table, content, head)</code></pre>
<p><br></p>
<p>Selecciono los municipios de Teruel. Se me hace raro seleccionar con R-base pero es la √∫nica forma que conozco de seleccionar en <code>SpatialPoly</code>.</p>
<pre class="r"><code>sel &lt;- municipios$NombreProv == &quot;Teruel&quot;
municipios &lt;- municipios[sel,]</code></pre>
<p><br></p>
<p>A fusionar los ficheros de lindes con los de altitud sacados de Internete; es decir, incorporo la informaci√≥n de altitudes y dem√°s al fichero con los pol√≠gonos espaciales.</p>
<pre class="r"><code>aa &lt;- municipios@data
municipios@data &lt;-  left_join( municipios@data , Teruel, by = c(&quot;NombreMuni&quot;= &quot;Nombre&quot;))</code></pre>
<p><br></p>
<p>Pues ya est√°. S√≥lo queda hacer el gr√°fico con <code>sp::spplot</code>:</p>
<pre class="r"><code>sp::spplot(municipios, zcol = &quot;Altitud&quot;, cuts = 2, col.regions  = c(&quot;cadetblue1&quot;, &quot;antiquewhite2&quot;, &quot;antiquewhite4&quot;))</code></pre>
<p><img src="/post/2018-01-18-altitud-municipios-teruel-mapas_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Gr√°fico de los municipios por altura. En color azulito las zonas por debajo de 600 metros, aproximadamente el <a href="https://es.wikipedia.org/wiki/Bajo_Arag%C3%B3n">Bajo Arag√≥n</a>. En marr√≥n oscuro las zonas m√°s altas entre ellas mi pueblo.</p>
<p>Tengo que aprender un poco de palettes!! Justo acabo de ver <a href="https://github.com/AndreaCirilloAC/paletter">este pkg</a></p>
<p>Pero seguro que con <code>tmap</code> sale m√°s bonito, y voy a poner alg√∫n corte m√°s en la escala</p>
<pre class="r"><code>library(tmap)
library(viridisLite)

  tm_shape(municipios, alpha = 0.3) +
  tm_fill(col = &quot;Altitud&quot;, title = &quot;Altitud&quot;, n = 5) +
  tm_polygons(border.alpha = 0.6) +
  tm_layout(legend.position = c(&quot;right&quot;, &quot;bottom&quot;))</code></pre>
<p><img src="/post/2018-01-18-altitud-municipios-teruel-mapas_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>S√≠!! Sale un poco m√°s bonito.</p>
<p><br></p>
<p>Ahora un gr√°fico con los pueblos m√°s altos que Pancrudo. Pancrudo es mi pueblo y lo voy a poner en rojo. En marr√≥n oscuro los que nos ganan en altura. Tan tan arriba no creo que sea sano vivir!! üò® üòÉ</p>
<p><br></p>
</div>
<div id="mapa-con-los-pueblos-mas-altos-que-pancrudo" class="section level3">
<h3>Mapa con los pueblos m√°s altos que Pancrudo</h3>
<pre class="r"><code>#jpeg(&quot;./grafico_altura_Teruel.jpg&quot;)
#dev.off()
plot(municipios, col = &quot;antiquewhite2&quot;) 
my_sel &lt;- subset(municipios, municipios$NombreMuni == &quot;Pancrudo&quot;)
sel &lt;- municipios$Altitud &gt; my_sel$Altitud  &amp; !is.na(municipios$Altitud)
plot(municipios[ sel, ], col = &quot;antiquewhite4&quot;, add = TRUE) 
sel &lt;- municipios$Altitud == my_sel$Altitud  &amp; !is.na(municipios$Altitud)
plot(municipios[ sel, ], col = &quot;red&quot;, add = TRUE) # add selected zones to map</code></pre>
<p><img src="/post/2018-01-18-altitud-municipios-teruel-mapas_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Como veis, Pancrudo est√° bastante alto, 1.235 metros seg√∫n la Wiki, un poco menos seg√∫n mi primo. Rillo nos gana, pero solo por 34 metros. ¬øSeguro que han medido bien?</p>
<p>Ya que estamos me da curiosidad y quiero hacer el <strong>mapa por densidad de poblaci√≥n</strong>:</p>
<p><br></p>
</div>
<div id="mapa-por-densidad-de-poblacion" class="section level2">
<h2>Mapa por densidad de poblaci√≥n</h2>
<pre class="r"><code>sp::spplot(municipios, zcol = &quot;Densidad&quot;, cuts = 2, col.regions  = c(&quot;cadetblue1&quot;, &quot;antiquewhite2&quot;, &quot;antiquewhite4&quot;))</code></pre>
<p><img src="/post/2018-01-18-altitud-municipios-teruel-mapas_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Las 3 poblaciones en marr√≥n (densidad &gt; q casi 60) son en este orden Utrillas, Teruel y Andorra. El agujero (pol√≠gono en blanco) que hay al lado de Teruel creo que es La Puebla de valverde. Aparece en blanco porque en los datos sacados del INE su nombre es ‚ÄúPuebla de Valverde, La‚Äù y en la tabla de internet es ‚ÄúLa Puebla de Valverde‚Äù. No lo arreglo porque este blog es para aprender y relajarme y ya vale por hoy.</p>
<p><br></p>
<p>Bueno, como veis mis conocimientos sobre gr√°ficos espaciales (y gr√°ficos en general) en R es limitado, pero estoy en ello. De hecho hace como a√±o y medio hacia gr√°ficos bastante m√°s potentes. Us√© <code>ggmpap</code> <code>leaflet</code> y <code>ggplot2</code> y alguno m√°s, pero todo se olvida, y ahora prefiero empezar con datos espaciales por lo nuevo; that is, el pkg <code>sf</code>. üòé, pero ser√° en el pr√≥ximo post.</p>
<p><br></p>
<p><strong>P.S:</strong> (Bastante t√©cnico, al menos para mi)</p>
<p>Resulta que yo quer√≠a haber puesto los 2 post sobre altitudes en uno s√≥lo, pero resulta que cuando los juntaba me daba problemas la datatable. Mirando por internet vi la soluci√≥n <a href="https://stackoverflow.com/questions/43594039/dt-package-not-working-with-blogdown-using-hugo-future-imperfect-theme">aqu√≠</a>, pero funciona s√≥lo a medias. La verdad es que lo mejor de R es la comunidad de usuarios!!</p>
<p>La soluci√≥n consiste en grabar la datatable como un objeto e insertarla en un iframe. Abajo est√° el c√≥digo.</p>
<pre class="r"><code>library(DT)
aa &lt;- decimales_df_pjp(Teruel, 2)  %&gt;% select(1,7,3,5) #- rtdos con 2 decimales
datatable_Teruel &lt;- datatable(aa, extensions = &#39;Scroller&#39;, options = list( pageLength = 10, deferRender = TRUE,scrollY = 400,scroller = TRUE), rownames = F, filter = &quot;top&quot;)</code></pre>
<pre class="r"><code>library(htmlwidgets)
library(htmltools)
htmlwidgets::saveWidget(datatable_Teruel, file = &quot;C://Users/perezp/desktop/datatable_Teruel.html&quot;, selfcontained = TRUE)</code></pre>
<p>e insertar la datatable as√≠</p>
<pre class="yaml"><code>Tabla: Municipios de Teruel ordenados por altitud

&lt;iframe seamless src=&quot;/datatable_Teruel.html&quot; width=&quot;100%&quot; height=&quot;500&quot;&gt;&lt;/iframe&gt;</code></pre>
</div>
